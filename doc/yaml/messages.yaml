openapi: 3.0.3
info:
  title: "User/VIP/admin"
  description: "Backend API for authentication"
  license:
    name: Apache 2.0
    url: http://www.apache.org/licenses/LICENSE-2.0.html
  version: 1.0.0
tags:
- name: "messages"
- name: "users"
- name: "channels"
  
paths:
  /messages/: 
    get:
      tags:
        - messages 
      description: Get all messages. Filtering is strongly advised.
      operationId: getMessages
      parameters:
        - name: page
          in: query
          description: To paginate results.
          schema:
            type: integer
            minimum: 1
        - name: popular
          in: query
          description: Get only pupular messages, value determines the timeframe. If used together with unpopular 
            it will perform an or.
          schema:
            type: string 
            enum:
              - today
              - week 
              - month 
              - year
              - all
        - name: unpopular
          in: query
          description: Get only unpupular messages, value determines the timeframe. If used together with popular 
            it will perform an or.
          schema:
            type: string 
            enum:
              - today
              - week 
              - month 
              - year
              - all
        - name: controversial
          in: query
          description: Get only controversial messages, value determines the timeframe. 
          schema:
            type: string 
            enum:
              - today
              - week 
              - month 
              - year
              - all
        - name: risk
          in: query
          description: Get only messages at risk of being controversial, popular or unpopular. 
          schema:
            type: string 
            enum:
              - controversial
              - popular 
              - unpopular
        - name: before
          in: query
          description: Get only messages dated before given timestamp.
          schema:
            type: string 
            format: date-time
        - name: after
          in: query
          description: Get only messages dated after given timestamp.
          schema:
            type: string 
            format: date-time
        - name: dest
          in: query
          description: Get only messages addressed to values. If value starts with @ it will be interpreted
            as a handle, if it starts with a § it will be interpreted as a channel name and if it starts with
            a \# it will be interpreted as a keyword channel. Otherwise this field will be ignored.
          schema:
            type: string 
            example: ['#sanremo1312', '@feltri', '§canalebello67']
      responses:
        200: 
          description: Ok 
          content:
            application/json:
              schema: 
                type: array 
                items:
                  $ref: '#/components/schemas/Message'

  /user/{handle}/messages/:
    get:
      tags:
        - messages
      description: Get all the messages of a specific user
      operationId: getUserMessages
      security:
        - adminAuth: []
        - userAuth: []
      parameters:
        - name: handle
          in: path
          description: The user's handle
          required: True
          schema: 
            type: string
            example: userHandle123
        - name: page
          in: query
          description: To paginate results.
          schema:
            type: integer
            minimum: 1
        - name: popular
          in: query
          description: Get only pupular messages, value determines the timeframe. If used together with unpopular 
            it will perform an or.
          schema:
            type: string 
            enum:
              - today
              - week 
              - month 
              - year
              - all
        - name: unpopular
          in: query
          description: Get only unpupular messages, value determines the timeframe. If used together with popular 
            it will perform an or.
          schema:
            type: string 
            enum:
              - today
              - week 
              - month 
              - year
              - all
        - name: controversial
          in: query
          description: Get only controversial messages, value determines the timeframe. 
          schema:
            type: string 
            enum:
              - today
              - week 
              - month 
              - year
              - all
        - name: risk
          in: query
          description: Get only messages at risk of being controversial, popular or unpopular. 
          schema:
            type: string 
            enum:
              - controversial
              - popular 
              - unpopular
        - name: before
          in: query
          description: Get only messages dated before given timestamp.
          schema:
            type: string 
            format: date-time
        - name: after
          in: query
          description: Get only messages dated after given timestamp.
          schema:
            type: string 
            format: date-time
        - name: dest
          in: query
          description: Get only messages addressed to values. If value starts with @ it will be interpreted
            as a handle, if it starts with a § it will be interpreted as a channel name and if it starts with
            a \# it will be interpreted as a keyword channel. Otherwise this field will be ignored.
          schema:
            type: string 
            example: ['#sanremo1312', '@feltri', '§canalebello67']
      responses:
        '200':
          description: User found
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Message'
        '401':
          description: Unauthorized operation
        '409':
          description: Invalid handle
    post:
      tags:
        - messages
      description: Post a new Message. This operation will also adjust the poster's character quotas,
        if there are not enough characters it will fail with error 418.
      operationId: postUserMessage
      security:
        - adminAuth: []
        - userAuth: []
      requestBody:
        description: message to be posted
        required: True
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/MessageInfo'
                
      parameters:
        - name: handle
          in: path
          description: The user's handle
          required: True
          schema: 
            type: string
            example: userHandle123
      responses:
        '200':
          description: Message posted successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Message'
        '401':
          description: Unauthorized operation.
        '409':
          description: Invalid handle.
        418: 
          description: User did not have enough characters left.
          
    delete:
      tags:
        - messages
      description: Delete all messages from the user with the given handle
      operationId: deleteUserMessages
      security:
        - adminAuth: []
        - userAuth: []
      parameters:
        - name: handle
          in: path
          description: The user's handle
          required: True
          schema: 
            type: string
            example: userHandle123
      responses:
        '200':
          description: Messages Deleted
        '401':
          description: Unauthorized operation
        '409':
          description: Invalid handle
    
  /user/{handle}/messages/{id}:
  
    delete:
      tags:
        - users
        - messages
      description: Delete the message with the given id from the user with the given handle.
      operationId: deleteMessage
      security:
        - adminAuth: []
        - userAuth: []
      parameters:
        - name: handle
          in: path
          description: The user's handle
          required: True
          schema: 
            type: string
            example: userHandle123
        - name: id
          in: path
          description: The message's id
          required: True
          schema:
            type: integer
            format: int64
      responses:
        '200':
          description: Message Deleted
        '401':
          description: Unauthorized operation
        '409':
          description: Invalid handle
    post:
      tags:
        - users
        - messages
      description: Change message data. Currently only the reactions can be changed by an admin.
      operationId: postMessage
      security:
        - adminAuth: []
      parameters:
        - name: handle
          in: path
          description: The user's handle
          required: True
          schema: 
            type: string
            example: userHandle123
        - name: id
          in: path
          description: The message's id
          required: True
          schema:
            type: integer
            format: int64
      requestBody:
        required: True
        description: The data to be changed
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/MessageImpressions'
      responses:
        '200':
          description: Message Modified
        '401':
          description: Unauthorized operation
        '409':
          description: Invalid handle

  /channel/{name}/messages: 
    delete:
      tags:
        - messages
        - channels 
      description: Delete all of a channel's messages. The channel will be removed from the dest list of 
        all messages. If it was the only dest the message will be removed.
      operationId: deleteChannelMessages
      parameters:
        - name: name 
          in: path 
          required: True
          schema:
            type: number
            description: The channel's name,
            format: int64
      security:
        - userAuth: []  # Only the owner can call it with a user token
        - adminAuth: []
      responses:
        200: 
          description: All messages deleted.
        400: 
          description: Channel id not found
        409: 
          description: Unauthorized 
        500: 
          description: Intiernal Server Error

components:
  schemas:
    Message:
      allOf:
        - $ref: '#/components/schemas/MessageInfo'
        - $ref: '#/components/schemas/MessageImpressions'
        - type: object
          required: [id]
          properties:
            id:
              type: integer
              format: int64
              description: The message's numerical id
    MessageImpressions:
      type: object
      required: [viewed, reactions]
      properties:
        viewed:
              type: integer
              description: Number of time the message has been viewed
              minimum: 0
        reactions:
          type: object
          required: [positive, negative]
          description: Bookkeeping data on reactions
          properties:
            positive:
              type: object
              description: Numbers of positive reactions divided by types
              properties:
                agree:
                  type: integer
                  minimum: 0
                strongAgree: 
                  type: integer
                  minimum: 0
            negative:
              type: object
              description: Numbers of negative reactions divided by types
              properties:
                disagree:
                  type: integer
                  minimum: 0
                strongDisagree: 
                  type: integer
                  minimum: 0
    MessageInfo:
      type: object
      required: [content, posted, author, dest]
      properties:
        content:
          type: object
          properties:
            text: 
              type: string
              example: This is an example squeal that contains very interesting info.
            image:
              type: string
              format: binary
              description: An image
        posted:
          type: string
          description: Message's timestamp
          format: date-time
          example: "2021-01-30T08:30:00Z"
        author:
          type: string
          description: The author's handle
          example: pieraldo196
        dest:
          type: array
          items:
            type: string
            description: The handle for single individuals, the channel name for channels
          example: ['@gianni', '@alberto', '§canalebello']
  securitySchemes:
      userAuth:
        type: http
        scheme: bearer
        bearerFormat: JWT
        description: Requires Requires a JWT token generated with user credentials. Even with a correctly formed JWT, a user can only alter their own account.
      adminAuth:
        type: http
        scheme: bearer
        bearerFormat: JWT
        description: Requires a JWT token generated with admin credentials.
      